// Native fetch is available in Node 18+

async function testRegistration() {
  const baseUrl = "http://localhost:3000/api/register";

  console.log("--- START PENTEST: Registration Validation ---");

  // Test 1: Weak Password
  const weakUser = {
    username: "pentest_weak",
    email: "weak@test.com",
    password: "weak",
    nama_depan: "Test",
    nama_belakang: "Weak",
  };

  console.log(`\n1. Testing Weak Password: ` + weakUser.password);
  try {
    const res = await fetch(baseUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(weakUser),
    });
    const data = await res.json();
    console.log(`Status: ${res.status}`);
    console.log(`Response: ${JSON.stringify(data)}`);

    if (
      res.status === 400 &&
      data.error &&
      data.error.includes("Password minimal 8 karakter")
    ) {
      console.log("✅ PASS: Weak password rejected correctly.");
    } else {
      // It might return other error if username exists, but we expect password error
      console.log("ℹ️ CHECK: Did validation fail? " + JSON.stringify(data));
    }
  } catch (e) {
    console.error("Error:", e.message);
  }

  // Test 2: Invalid Email
  const badEmail = {
    username: "pentest_bademail",
    email: "notanemail",
    password: "StrongPassword1!",
    nama_depan: "Test",
    nama_belakang: "BadEmail",
  };

  console.log(`\n2. Testing Invalid Email: ` + badEmail.email);
  try {
    const res = await fetch(baseUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(badEmail),
    });
    const data = await res.json();
    console.log(`Status: ${res.status}`);
    console.log(`Response: ${JSON.stringify(data)}`);

    if (
      res.status === 400 &&
      data.error &&
      data.error.includes("Format email tidak valid")
    ) {
      console.log("✅ PASS: Invalid email rejected correctly.");
    } else {
      console.log("❌ FAIL: Invalid email NOT rejected.");
    }
  } catch (e) {
    console.error("Error:", e.message);
  }

  // Test 3: Valid User
  const validUser = {
    username: "pentest_valid_" + Date.now(),
    email: `valid${Date.now()}@test.com`,
    password: "StrongPassword1!",
    nama_depan: "Test",
    nama_belakang: "Valid",
  };

  console.log(`\n3. Testing Valid User: ` + validUser.username);
  try {
    const res = await fetch(baseUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(validUser),
    });
    const data = await res.json();
    console.log(`Status: ${res.status}`);
    console.log(`Response: ${JSON.stringify(data)}`);

    if (res.status === 201) {
      console.log("✅ PASS: Valid user registered successfully.");
    } else {
      console.log("❌ FAIL: Valid user failed to register.");
    }
  } catch (e) {
    console.error("Error:", e.message);
  }

  console.log("\n--- END PENTEST ---");
}

testRegistration();
